version: 2.1
jobs:
  build-and-test:
    docker:
      - image: 'cimg/python:3.12.5'
    steps:
      - checkout
      - restore_cache:
          keys:
            - 'v1-dependencies-{{ checksum "requirements.txt" }}'
      - run:
          name: Install Dependencies
          command: pip install --no-cache-dir -r requirements.txt
      - save_cache:
          paths:
            - ./venv
          key: 'v1-dependencies-{{ checksum "requirements.txt" }}'
      - run:
          name: Run Tests
          command: pytest tests/ -v
      - run:
          name: Build Docker Image
          command: 'docker build -t $DOCKER_USERNAME/churn-prediction:latest . .'
      - run:
          name: Docker Login
          command: docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
      - run:
          name: Push Docker Image
          command: 'docker push $DOCKER_USERNAME/churn-prediction:latest'
  
workflows:
  build-deploy:
    jobs:
      - build-and-test 
